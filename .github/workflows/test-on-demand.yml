name: "Test Scenario (On-Demand)"

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Repository tag to test'
        required: true
        default: 'main'

jobs:
  api-tests:
    name: API Test Scenario
    runs-on: ubuntu-latest

    env:
      TEST_BASEURLIDP: ${{ secrets.TEST_BASEURLIDP }}
      TEST_CLIENTID: ${{ secrets.TEST_CLIENTID }}
      TEST_SCOPE: ${{ secrets.TEST_SCOPE }}
      TEST_USERNAME: ${{ secrets.TEST_USERNAME }}
      TEST_USERPASS: ${{ secrets.TEST_USERPASS }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag }}

      - name: Run Newman CLI reporter
        run: |
          set -o pipefail
          docker run --rm \
            -v "${{ github.workspace }}:/etc/newman" \
            postman/newman:6-ubuntu \
            run tests/TERRA-AAI-Tests.postman_collection.json \
            --env-var "baseUrlIdp=${{ env.TEST_BASEURLIDP }}" \
            --env-var "clientId=${{ env.TEST_CLIENTID }}" \
            --env-var "scope=${{ env.TEST_SCOPE }}" \
            --env-var "userName=${{ env.TEST_USERNAME }}" \
            --env-var "userPass=${{ env.TEST_USERPASS }}" \
            --reporters cli,emojitrain